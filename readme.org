#+TITLE: Justcxx: Declarative Rust-C++ FFI Binding Generator
#+AUTHOR: lyuweii

* Introduction
JustCxx is a high-level interoperability tool built on top of the
=cxx= crate. It automates the generation of FFI binding code between
Rust and C++ through a declarative Rust macro.

Unlike raw =cxx=, JustCxx v0.2 introduces a *Unified Generic Wrapper*
architecture, mapping C++ objects to a single Rust generic struct.

*Disclaimer*: This library is in *early development stage
(v0.2)*. APIs are unstable and subject to breaking changes. If you
require advanced C++ features (inheritance, complex templates) or
manual control, consider using [[https://github.com/google/autocxx][autocxx]] or raw [[https://cxx.rs][cxx]].

* Quick Start
** 1. Dependencies
Add to =Cargo.toml= (Note: =cxx= is required as a peer dependency):
#+begin_src toml
[dependencies]
cxx = "1.0"
justcxx = { version = "0.2" }

[build-dependencies]
justcxx-build = { version = "0.2" }
#+end_src

** 2. Build Script (build.rs)
#+begin_src rust
fn main() {
    justcxx_build::bridge("src/lib.rs")
        .file("src/cpp/my_class.cc")
        .compile("my-cxx-lib");
    println!("cargo:rerun-if-changed=src/lib.rs");
}
#+end_src

** 3. Writing DSL (src/lib.rs)
#+begin_src rust
use justcxx::{bind, CppRef, CppMut, CppOwned};

bind! {
    include!("my_cpp_header.hh");

    struct Config {
        id: i32,
    }

    impl Config {
        fn new() -> Self; // Constructor
        fn get_id(&self) -> i32;
        fn set_id(&mut self, v: i32);
    }
}
#+end_src

* Type System Guide
JustCxx exposes three main aliases to handle C++ object lifecycles.

** 1. CppOwned<T>
Represents an owned C++ object (wrapping =std::unique_ptr<T>=).
- Created by constructors (=fn new() -> Self=).
- Has move semantics.

** 2. CppRef<T>
Represents a const reference (=const T&=).
- Zero-cost wrapper (holds a pointer).
- Implements =Copy=.
- Usage: Function arguments where read-only access is needed.

** 3. CppMut<T>
Represents a mutable reference (=T&=).
- Zero-cost wrapper (holds a pointer).
- Implements =Copy=.
- Usage: Function arguments where mutation is needed.

** Usage Example
#+begin_src rust
// Define function accepting a reference
fn print_config(c: CppRef<Config>) {
    println!("{}", c.get_id());
}

fn main() {
    let mut c: CppOwned<Config> = Config::new();
    
    // Explicit conversion required
    print_config(c.as_ref());
    
    // Mutation
    c.as_mut().set_id(100);
}
#+end_src

* DSL Syntax
** Structs & Field Accessors
Defining a field in the struct does *not* create a public Rust field.
Instead, JustCxx automatically generates accessor methods.

#+begin_src rust
struct Manager {
    id: i32,                 // Basic type    
    #[readonly] 
    name: String,            // string type, no set     
    obj: Config,             // C++ Object
    list: Vec<Config>,       // Vector of Objects
    nums: Vec<i32>,          // Vector of Primitives
    dict: Map<String, i32>,  // Map
}
#+end_src

Generated methods for =Manager=:
- =fn id(&self) -> i32= (Getter)
- =fn set_id(&mut self, val: i32)= (Setter)
- =fn name(&self) -> String= (Read-only Getter)

** Methods
| Rust Syntax | C++ Semantic | Note |
|-------------|--------------|------|
| =fn new() -> Self= | Constructor | Must be static |
| =fn foo(&self)= | Const Method | |
| =fn bar(&mut self)= | Mutable Method | |
| =fn baz()= | Static Method | |

* Container Support
** Vec<T> (Objects)
- =get(i) -> CppRef<T>=
- =get_mut(i) -> CppMut<T>=
- =iter()= / =iter_mut()=

** Vec<Primitive> (e.g., Vec<i32>)
Optimized for performance.
- =get(i) -> T= (Copy)
- =get_mut(i) -> &mut T= (Native Rust Reference)
- =as_slice() -> &[T]= (Zero-copy)
- =as_mut_slice() -> &mut [T]=

** Vec<String>
- =get(i) -> String= (Copy)
- =set(i, &str)=
- =iter() -> String=

** Map<K, V>
Supports =std::unordered_map=.
- =get(key) -> Option<V>=
- =iter()= (Returns Key/Value pairs)

* Limitations
1. *Map Keys*: Must be basic types or Strings. Object keys are not supported.
2. *String*: =std::string= is copied to Rust =String= when returned by value or accessed in vector.
3. *Dependencies*: Must add =cxx = "1.0"= to your Cargo.toml manually.
